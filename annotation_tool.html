<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Classification Annotation Tool</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ“</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: monospace; background: #fafafa; color: #222; font-size: 14px; }

        .header { background: #222; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 16px; font-weight: normal; }
        .accuracy { font-size: 18px; font-weight: bold; }

        .controls { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 15px; align-items: center; }
        select, button { font-family: monospace; padding: 8px 12px; border: 1px solid #ccc; background: #fff; font-size: 14px; }
        button { cursor: pointer; background: #222; color: #fff; border: none; }
        button:hover { background: #444; }
        button:disabled { background: #ccc; }

        .main { padding: 20px; max-width: 1200px; }

        .prompt-section { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-left: 3px solid #222; }
        .prompt-section h2 { font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 10px; }
        .prompt-section pre { white-space: pre-wrap; font-size: 12px; line-height: 1.5; }

        .sample { background: #fff; border: 1px solid #ddd; margin-bottom: 20px; }
        .sample-header { padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: bold; }
        .sample-footer { padding: 10px 15px; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; }

        .sample-content { padding: 15px; }

        .section-title { font-size: 11px; text-transform: uppercase; color: #fff; background: #666; padding: 5px 10px; margin: 15px 0 10px 0; }
        .section-title.input { background: #555; }
        .section-title.output { background: #2a6; }
        .section-title:first-child { margin-top: 0; }

        .field { margin-bottom: 10px; padding-left: 10px; border-left: 2px solid #ddd; }
        .field-label { font-size: 11px; color: #888; margin-bottom: 3px; }
        .field-value { background: #f8f8f8; padding: 8px; font-size: 13px; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; }
        .field.output .field-value { background: #e8f4e8; }

        .email-block { background: #f5f5f5; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .email-meta { font-size: 12px; color: #666; margin-bottom: 5px; }
        .email-body { white-space: pre-wrap; font-size: 13px; max-height: 300px; overflow-y: auto; }

        .buttons { display: flex; gap: 8px; }
        .btn { padding: 8px 20px; border: 2px solid; background: #fff; cursor: pointer; font-family: monospace; font-size: 14px; }
        .btn-correct { border-color: #4a4; color: #4a4; }
        .btn-correct.selected { background: #4a4; color: #fff; }
        .btn-incorrect { border-color: #a44; color: #a44; }
        .btn-incorrect.selected { background: #a44; color: #fff; }
        .btn-skip { border-color: #888; color: #888; }
        .btn-skip.selected { background: #888; color: #fff; }

        .progress { height: 4px; background: #ddd; }
        .progress-bar { height: 100%; background: #4a4; transition: width 0.2s; }

        .status { padding: 40px; text-align: center; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI Classification Annotation Tool</h1>
        <div class="accuracy" id="accuracy">--</div>
    </div>

    <div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>

    <div class="controls">
        <input type="file" id="dbFile" accept=".db,.sqlite,.sqlite3" style="display:none">
        <button id="loadDbBtn">Load Database</button>
        <span id="dbName" style="color:#666; margin-right:10px;">No database loaded</span>
        <select id="runSelect" disabled><option>Select database first</option></select>
        <select id="sampleSize">
            <option value="10">10 samples</option>
            <option value="20" selected>20 samples</option>
            <option value="50">50 samples</option>
        </select>
        <button id="loadBtn" style="display:none">Load</button>
        <button id="saveScoreBtn" disabled style="background:#2a6">Save Score</button>
        <span id="saveStatus" style="color:#666; margin-left:10px;"></span>
    </div>

    <div class="main">
        <div class="prompt-section" id="promptSection" style="display:none">
            <h2>Prompt Template</h2>
            <pre id="promptText"></pre>
        </div>

        <div id="samples">
            <div class="status">Loading database...</div>
        </div>
    </div>

    <script>
        let db, SQL, samples = [], annotations = {}, currentRun, dbTables = [];

        const DEFAULT_DB = 'epstein_analysis.db';

        // Initialize SQL.js and try to load default database
        initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` })
            .then(sql => {
                SQL = sql;
                document.getElementById('samples').innerHTML = '<div class="status">Loading database...</div>';

                // Try to load default database
                fetch(DEFAULT_DB)
                    .then(r => {
                        if (!r.ok) throw new Error('Not found');
                        return r.arrayBuffer();
                    })
                    .then(buf => {
                        db = new SQL.Database(new Uint8Array(buf));
                        document.getElementById('dbName').textContent = DEFAULT_DB;

                        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
                        dbTables = tables[0] ? tables[0].values.map(r => r[0]) : [];

                        loadRuns();
                    })
                    .catch(() => {
                        document.getElementById('samples').innerHTML = '<div class="status">Click "Load Database" to select a SQLite database file<br><small style="color:#999">Or run: python -m http.server 8001</small></div>';
                    });
            });

        // Handle database file selection
        document.getElementById('loadDbBtn').onclick = () => document.getElementById('dbFile').click();

        document.getElementById('dbFile').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('samples').innerHTML = '<div class="status">Loading database...</div>';

            const reader = new FileReader();
            reader.onload = () => {
                db = new SQL.Database(new Uint8Array(reader.result));
                document.getElementById('dbName').textContent = file.name;

                // Get list of tables
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
                dbTables = tables[0] ? tables[0].values.map(r => r[0]) : [];

                loadRuns();
            };
            reader.readAsArrayBuffer(file);
        };

        function loadRuns() {
            const sel = document.getElementById('runSelect');
            sel.innerHTML = '';

            // Check if ai_classification_runs table exists
            if (!dbTables.includes('ai_classification_runs')) {
                sel.innerHTML = '<option>No ai_classification_runs table</option>';
                document.getElementById('samples').innerHTML = '<div class="status">This database has no ai_classification_runs table. Create one to use this tool.</div>';
                return;
            }

            const runs = db.exec("SELECT * FROM ai_classification_runs");
            if (!runs[0] || runs[0].values.length === 0) {
                sel.innerHTML = '<option>No runs found</option>';
                document.getElementById('samples').innerHTML = '<div class="status">No classification runs registered in ai_classification_runs</div>';
                return;
            }

            runs[0].values.forEach(row => {
                const run = {};
                runs[0].columns.forEach((c, i) => run[c] = row[i]);
                const opt = document.createElement('option');
                opt.value = JSON.stringify(run);
                opt.textContent = `${run.run_id}: ${run.run_name}`;
                sel.appendChild(opt);
            });

            sel.disabled = false;
            document.getElementById('loadBtn').disabled = false;
            document.getElementById('samples').innerHTML = '<div class="status">Select a classifier run</div>';

            // Auto-load on change
            sel.onchange = () => document.getElementById('loadBtn').click();
            document.getElementById('sampleSize').onchange = () => document.getElementById('loadBtn').click();

            // Auto-select first and load
            if (sel.options.length > 0) {
                sel.selectedIndex = 0;
                document.getElementById('loadBtn').click();
            }
        }

        document.getElementById('loadBtn').onclick = async () => {
            currentRun = JSON.parse(document.getElementById('runSelect').value);
            annotations = {};

            // Show prompt
            if (currentRun.prompt_used) {
                document.getElementById('promptText').textContent = currentRun.prompt_used;
                document.getElementById('promptSection').style.display = 'block';
            } else {
                document.getElementById('promptSection').style.display = 'none';
            }

            // Parse input columns (format: ["table.column", ...])
            let inputCols = [];
            try {
                inputCols = JSON.parse(currentRun.input_columns || '[]');
            } catch(e) {
                inputCols = (currentRun.input_columns || '').split(',').map(s => s.trim());
            }

            // Parse output columns (format: ["table.column", ...])
            let outputCols = [];
            try {
                outputCols = JSON.parse(currentRun.output_columns || '[]');
            } catch(e) {
                outputCols = (currentRun.output_columns || '').split(',').map(s => s.trim());
            }

            // Extract output table from first output column
            const firstOutputCol = outputCols[0] || '';
            if (firstOutputCol.includes('filtered')) {
                document.getElementById('samples').innerHTML = '<div class="status">No output table for this run (filtered data)</div>';
                return;
            }
            const outputTable = firstOutputCol.split('.')[0];
            if (!outputTable) {
                document.getElementById('samples').innerHTML = '<div class="status">No output table specified in output_columns</div>';
                return;
            }

            // Check if table exists
            if (!dbTables.includes(outputTable)) {
                document.getElementById('samples').innerHTML = `<div class="status">Table "${outputTable}" not found in database</div>`;
                return;
            }

            const size = document.getElementById('sampleSize').value;

            // Fetch samples from output table
            const result = db.exec(`SELECT * FROM "${outputTable}" ORDER BY RANDOM() LIMIT ${size}`);
            if (!result[0]) {
                document.getElementById('samples').innerHTML = '<div class="status">No data in table</div>';
                return;
            }

            const cols = result[0].columns;
            // Extract just column names from table.column format
            const outputColNames = outputCols.map(c => c.includes('.') ? c.split('.')[1] : c);

            // Extract just column names from input_columns (table.column -> column)
            const inputColNames = inputCols.map(c => c.includes('.') ? c.split('.').slice(1).join('.') : c);

            samples = result[0].values.map((row, i) => {
                const s = { _idx: i, _cols: cols, _outputCols: outputColNames, _inputCols: inputColNames };
                cols.forEach((c, j) => s[c] = row[j]);
                return s;
            });

            // Enrich samples with expanded data
            enrichSamples(samples, inputCols);

            render();
            document.getElementById('saveScoreBtn').disabled = true;
            document.getElementById('saveStatus').textContent = '';
        };

        function enrichSamples(samples, inputCols) {
            // Generic expansion: look for JSON array columns that reference other tables
            for (const sample of samples) {
                sample._expanded = {};

                // Check each column for expandable content
                for (const col of sample._cols) {
                    const val = sample[col];
                    if (!val || typeof val !== 'string') continue;

                    // Try to parse as JSON array
                    if (val.startsWith('[') && val.endsWith(']')) {
                        try {
                            const arr = JSON.parse(val);
                            if (arr.length > 0 && typeof arr[0] === 'string') {
                                // Check if these look like IDs that could be expanded
                                // For now, just store parsed arrays for display
                                sample._expanded[col] = arr;
                            }
                        } catch(e) {}
                    }
                }
            }
        }

        function render() {
            const container = document.getElementById('samples');
            container.innerHTML = '';

            samples.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'sample';
                div.id = `s${i}`;

                const cols = s._cols;
                const outputColNames = s._outputCols;
                const inputColNames = s._inputCols;

                // Input fields: only columns that match input_columns
                const inputFields = cols.filter(c => inputColNames.some(ic => c === ic));
                // Output fields: only columns that match output_columns
                const outputFields = cols.filter(c => outputColNames.some(oc => c === oc));

                let html = `<div class="sample-header">#${i + 1}</div><div class="sample-content">`;

                // INPUT SECTION
                html += `<div class="section-title input">INPUT DATA</div>`;

                inputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '' && !c.startsWith('_')) {
                        // Skip thread_ids if we have expanded emails
                        if (c.includes('thread_ids') && s._expanded.emails) return;

                        let val = String(s[c]);
                        if (val.startsWith('[') && val.endsWith(']')) {
                            try { val = JSON.parse(val).join(',  '); } catch(e) {}
                        }
                        html += `<div class="field"><div class="field-label">${c}</div><div class="field-value">${esc(val)}</div></div>`;
                    }
                });

                // Show expanded emails
                if (s._expanded.emails) {
                    html += `<div class="field"><div class="field-label">Source Emails (${s._expanded.emails.length} shown)</div>`;
                    s._expanded.emails.forEach(email => {
                        html += `<div class="email-block">
                            <div class="email-meta"><b>From:</b> ${esc(email.sender || '')} <b>To:</b> ${esc(email.receiver || '')}</div>
                            <div class="email-body">${esc(email.body || '')}</div>
                        </div>`;
                    });
                    html += `</div>`;
                }

                // Show expanded cluster members
                if (s._expanded.members) {
                    html += `<div class="field"><div class="field-label">Cluster Members (${s._expanded.members.length})</div>
                        <div class="field-value">${s._expanded.members.map(m => esc(m)).join(',  ')}</div></div>`;
                }

                // OUTPUT SECTION
                html += `<div class="section-title output">AI OUTPUT (to evaluate)</div>`;

                outputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '') {
                        let val = String(s[c]);
                        // Format JSON arrays with spacing
                        if (val.startsWith('[') && val.endsWith(']')) {
                            try {
                                const arr = JSON.parse(val);
                                val = arr.join(',  ');
                            } catch(e) {}
                        }
                        html += `<div class="field output"><div class="field-label">${c}</div><div class="field-value">${esc(val)}</div></div>`;
                    }
                });

                html += `</div>
                    <div class="sample-footer">
                        <div class="buttons">
                            <button class="btn btn-correct" onclick="annotate(${i},'correct')">Correct</button>
                            <button class="btn btn-incorrect" onclick="annotate(${i},'incorrect')">Incorrect</button>
                            <button class="btn btn-skip" onclick="annotate(${i},'skip')">Skip</button>
                        </div>
                    </div>`;

                div.innerHTML = html;
                container.appendChild(div);
            });

            updateStats();
        }

        function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function annotate(i, v) {
            annotations[i] = v;
            document.querySelectorAll(`#s${i} .btn`).forEach(b => b.classList.remove('selected'));
            document.querySelector(`#s${i} .btn-${v}`).classList.add('selected');
            updateStats();

            // Enable save button if we have any correct/incorrect annotations
            const hasAnnotations = Object.values(annotations).some(v => v === 'correct' || v === 'incorrect');
            document.getElementById('saveScoreBtn').disabled = !hasAnnotations;
            document.getElementById('saveStatus').textContent = '';
        }

        function updateStats() {
            const n = samples.length;
            const done = Object.keys(annotations).length;
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;
            const total = correct + incorrect;

            const acc = total > 0 ? Math.round(correct / total * 100) : '--';
            document.getElementById('accuracy').textContent = `${acc}% (${correct}/${total})`;
            document.getElementById('progressBar').style.width = `${done / n * 100}%`;
        }

        document.getElementById('saveScoreBtn').onclick = async () => {
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;
            const total = correct + incorrect;

            if (total === 0) {
                document.getElementById('saveStatus').textContent = 'No annotations to save';
                return;
            }

            const score = correct / total;

            // Prepare annotations data
            const annotationData = samples
                .filter((s, i) => annotations[i] && annotations[i] !== 'skip')
                .map((s, i) => ({
                    thread_id: s.thread_id || s.id || `sample_${i}`,
                    annotation: annotations[i]
                }));

            const payload = {
                run_id: currentRun.run_id,
                score: score,
                annotations: annotationData
            };

            try {
                document.getElementById('saveStatus').textContent = 'Saving...';
                const response = await fetch('/save_annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('saveStatus').textContent =
                        `Saved! Score: ${Math.round(score * 100)}% (${result.annotations_saved} annotations)`;
                    document.getElementById('saveStatus').style.color = '#2a6';
                } else {
                    throw new Error('Save failed');
                }
            } catch(e) {
                document.getElementById('saveStatus').textContent = 'Error: Run annotation_server.py first';
                document.getElementById('saveStatus').style.color = '#a44';
            }
        };
    </script>
</body>
</html>
