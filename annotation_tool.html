<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classification Annotation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ“</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: monospace; background: #fafafa; color: #222; font-size: 14px; }

        .header { background: #222; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 16px; font-weight: normal; }
        .accuracy { font-size: 18px; font-weight: bold; }

        .controls { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 15px; align-items: center; }
        select, button { font-family: monospace; padding: 8px 12px; border: 1px solid #ccc; background: #fff; font-size: 14px; }
        button { cursor: pointer; background: #222; color: #fff; border: none; }
        button:hover { background: #444; }
        button:disabled { background: #ccc; }

        .main { padding: 20px; max-width: 1000px; }

        .prompt-section { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-left: 3px solid #222; }
        .prompt-section h2 { font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 10px; }
        .prompt-section pre { white-space: pre-wrap; font-size: 12px; line-height: 1.5; }

        .sample { background: #fff; border: 1px solid #ddd; margin-bottom: 15px; }
        .sample-header { padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .sample-num { font-weight: bold; }

        .sample-content { padding: 15px; }
        .field { margin-bottom: 12px; }
        .field-label { font-size: 11px; text-transform: uppercase; color: #888; margin-bottom: 4px; }
        .field-value { background: #f8f8f8; padding: 10px; border: 1px solid #eee; white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto; }
        .field-value.output { background: #e8f4e8; border-color: #c8e6c8; }

        .buttons { display: flex; gap: 8px; }
        .btn { padding: 6px 14px; border: 2px solid; background: #fff; cursor: pointer; font-family: monospace; font-size: 13px; }
        .btn-correct { border-color: #4a4; color: #4a4; }
        .btn-correct.selected { background: #4a4; color: #fff; }
        .btn-incorrect { border-color: #a44; color: #a44; }
        .btn-incorrect.selected { background: #a44; color: #fff; }
        .btn-skip { border-color: #888; color: #888; }
        .btn-skip.selected { background: #888; color: #fff; }

        .progress { height: 4px; background: #ddd; }
        .progress-bar { height: 100%; background: #4a4; transition: width 0.2s; }

        .status { padding: 40px; text-align: center; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Classification Annotation</h1>
        <div class="accuracy" id="accuracy">--</div>
    </div>

    <div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>

    <div class="controls">
        <select id="runSelect" disabled><option>Loading...</option></select>
        <select id="sampleSize">
            <option value="20">20 samples</option>
            <option value="50">50 samples</option>
        </select>
        <button id="loadBtn" disabled>Load</button>
        <button id="exportBtn" disabled>Export JSON</button>
    </div>

    <div class="main">
        <div class="prompt-section" id="promptSection" style="display:none">
            <h2>Prompt Template</h2>
            <pre id="promptText"></pre>
        </div>

        <div id="samples">
            <div class="status">Loading database...</div>
        </div>
    </div>

    <script>
        let db, samples = [], annotations = {}, currentRun;

        initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` })
            .then(SQL => fetch('epstein_analysis.db')
                .then(r => r.arrayBuffer())
                .then(buf => {
                    db = new SQL.Database(new Uint8Array(buf));
                    loadRuns();
                })
                .catch(() => document.getElementById('samples').innerHTML = '<div class="status">Run: python -m http.server 8001</div>')
            );

        function loadRuns() {
            const sel = document.getElementById('runSelect');
            sel.innerHTML = '';
            const runs = db.exec("SELECT * FROM ai_classification_runs");
            if (!runs[0]) return;

            runs[0].values.forEach(row => {
                const run = {};
                runs[0].columns.forEach((c, i) => run[c] = row[i]);
                const opt = document.createElement('option');
                opt.value = JSON.stringify(run);
                opt.textContent = `${run.run_id}: ${run.run_name}`;
                sel.appendChild(opt);
            });

            sel.disabled = false;
            document.getElementById('loadBtn').disabled = false;
            document.getElementById('samples').innerHTML = '<div class="status">Select a run and click Load</div>';
        }

        document.getElementById('loadBtn').onclick = () => {
            currentRun = JSON.parse(document.getElementById('runSelect').value);
            annotations = {};

            // Show prompt
            if (currentRun.prompt_used) {
                document.getElementById('promptText').textContent = currentRun.prompt_used;
                document.getElementById('promptSection').style.display = 'block';
            }

            // Get output table
            let table = currentRun.output_tables?.split(',')[0]?.trim();
            if (!table) return;

            const size = document.getElementById('sampleSize').value;
            const result = db.exec(`SELECT * FROM "${table}" ORDER BY RANDOM() LIMIT ${size}`);

            if (!result[0]) {
                document.getElementById('samples').innerHTML = '<div class="status">No data</div>';
                return;
            }

            const cols = result[0].columns;
            const outputCols = (currentRun.output_columns || '').split(',').map(c => c.trim().replace(/"/g, '').replace(/\s*\[C\d+\]/g, ''));

            samples = result[0].values.map((row, i) => {
                const s = { _idx: i };
                cols.forEach((c, j) => s[c] = row[j]);
                return s;
            });

            render(cols, outputCols);
            document.getElementById('exportBtn').disabled = false;
        };

        function render(cols, outputCols) {
            const container = document.getElementById('samples');
            container.innerHTML = '';

            samples.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'sample';
                div.id = `s${i}`;

                // Separate input vs output columns
                const inputFields = cols.filter(c => !outputCols.some(oc => c.toLowerCase().includes(oc.toLowerCase())));
                const outputFields = cols.filter(c => outputCols.some(oc => c.toLowerCase().includes(oc.toLowerCase())));

                let html = `
                    <div class="sample-header">
                        <span class="sample-num">#${i + 1}</span>
                        <div class="buttons">
                            <button class="btn btn-correct" onclick="annotate(${i},'correct')">Correct</button>
                            <button class="btn btn-incorrect" onclick="annotate(${i},'incorrect')">Incorrect</button>
                            <button class="btn btn-skip" onclick="annotate(${i},'skip')">Skip</button>
                        </div>
                    </div>
                    <div class="sample-content">
                `;

                // Input fields
                inputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '') {
                        html += `<div class="field"><div class="field-label">${c}</div><div class="field-value">${esc(String(s[c]))}</div></div>`;
                    }
                });

                // Output fields (highlighted)
                outputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '') {
                        html += `<div class="field"><div class="field-label">${c} (AI output)</div><div class="field-value output">${esc(String(s[c]))}</div></div>`;
                    }
                });

                html += '</div>';
                div.innerHTML = html;
                container.appendChild(div);
            });

            updateStats();
        }

        function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function annotate(i, v) {
            annotations[i] = v;
            document.querySelectorAll(`#s${i} .btn`).forEach(b => b.classList.remove('selected'));
            document.querySelector(`#s${i} .btn-${v}`).classList.add('selected');
            updateStats();
        }

        function updateStats() {
            const n = samples.length;
            const done = Object.keys(annotations).length;
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;
            const total = correct + incorrect;

            const acc = total > 0 ? Math.round(correct / total * 100) : '--';
            document.getElementById('accuracy').textContent = `${acc}% (${correct}/${total})`;
            document.getElementById('progressBar').style.width = `${done / n * 100}%`;
        }

        document.getElementById('exportBtn').onclick = () => {
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;

            const data = {
                run_id: currentRun.run_id,
                run_name: currentRun.run_name,
                date: new Date().toISOString(),
                accuracy: correct / (correct + incorrect) || null,
                correct, incorrect,
                skipped: Object.values(annotations).filter(v => v === 'skip').length,
                samples: samples.map((s, i) => ({ ...s, annotation: annotations[i] || null }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentRun.run_id}_annotation_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };
    </script>
</body>
</html>
