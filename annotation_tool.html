<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classification Annotation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ“</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: monospace; background: #fafafa; color: #222; font-size: 14px; }

        .header { background: #222; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 16px; font-weight: normal; }
        .accuracy { font-size: 18px; font-weight: bold; }

        .controls { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 15px; align-items: center; }
        select, button { font-family: monospace; padding: 8px 12px; border: 1px solid #ccc; background: #fff; font-size: 14px; }
        button { cursor: pointer; background: #222; color: #fff; border: none; }
        button:hover { background: #444; }
        button:disabled { background: #ccc; }

        .main { padding: 20px; max-width: 1200px; }

        .prompt-section { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-left: 3px solid #222; }
        .prompt-section h2 { font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 10px; }
        .prompt-section pre { white-space: pre-wrap; font-size: 12px; line-height: 1.5; }

        .sample { background: #fff; border: 1px solid #ddd; margin-bottom: 20px; }
        .sample-header { padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: bold; }
        .sample-footer { padding: 10px 15px; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; }

        .sample-content { padding: 15px; }

        .section-title { font-size: 11px; text-transform: uppercase; color: #fff; background: #666; padding: 5px 10px; margin: 15px 0 10px 0; }
        .section-title.input { background: #555; }
        .section-title.output { background: #2a6; }
        .section-title:first-child { margin-top: 0; }

        .field { margin-bottom: 10px; padding-left: 10px; border-left: 2px solid #ddd; }
        .field-label { font-size: 11px; color: #888; margin-bottom: 3px; }
        .field-value { background: #f8f8f8; padding: 8px; font-size: 13px; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; }
        .field.output .field-value { background: #e8f4e8; }

        .email-block { background: #f5f5f5; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .email-meta { font-size: 12px; color: #666; margin-bottom: 5px; }
        .email-body { white-space: pre-wrap; font-size: 13px; max-height: 300px; overflow-y: auto; }

        .buttons { display: flex; gap: 8px; }
        .btn { padding: 8px 20px; border: 2px solid; background: #fff; cursor: pointer; font-family: monospace; font-size: 14px; }
        .btn-correct { border-color: #4a4; color: #4a4; }
        .btn-correct.selected { background: #4a4; color: #fff; }
        .btn-incorrect { border-color: #a44; color: #a44; }
        .btn-incorrect.selected { background: #a44; color: #fff; }
        .btn-skip { border-color: #888; color: #888; }
        .btn-skip.selected { background: #888; color: #fff; }

        .progress { height: 4px; background: #ddd; }
        .progress-bar { height: 100%; background: #4a4; transition: width 0.2s; }

        .status { padding: 40px; text-align: center; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Classification Annotation</h1>
        <div class="accuracy" id="accuracy">--</div>
    </div>

    <div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>

    <div class="controls">
        <select id="runSelect" disabled><option>Loading...</option></select>
        <select id="sampleSize">
            <option value="10">10 samples</option>
            <option value="20" selected>20 samples</option>
            <option value="50">50 samples</option>
        </select>
        <button id="loadBtn" style="display:none">Load</button>
        <button id="exportBtn" disabled>Export JSON</button>
    </div>

    <div class="main">
        <div class="prompt-section" id="promptSection" style="display:none">
            <h2>Prompt Template</h2>
            <pre id="promptText"></pre>
        </div>

        <div id="samples">
            <div class="status">Loading database...</div>
        </div>
    </div>

    <script>
        let db, samples = [], annotations = {}, currentRun;

        initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` })
            .then(SQL => fetch('epstein_analysis.db')
                .then(r => r.arrayBuffer())
                .then(buf => {
                    db = new SQL.Database(new Uint8Array(buf));
                    loadRuns();
                })
                .catch(() => document.getElementById('samples').innerHTML = '<div class="status">Run: python -m http.server 8001</div>')
            );

        function loadRuns() {
            const sel = document.getElementById('runSelect');
            sel.innerHTML = '';
            const runs = db.exec("SELECT * FROM ai_classification_runs");
            if (!runs[0]) return;

            runs[0].values.forEach(row => {
                const run = {};
                runs[0].columns.forEach((c, i) => run[c] = row[i]);
                const opt = document.createElement('option');
                opt.value = JSON.stringify(run);
                opt.textContent = `${run.run_id}: ${run.run_name}`;
                sel.appendChild(opt);
            });

            sel.disabled = false;
            document.getElementById('loadBtn').disabled = false;
            document.getElementById('samples').innerHTML = '<div class="status">Select a run</div>';

            // Auto-load on change
            sel.onchange = () => document.getElementById('loadBtn').click();
            document.getElementById('sampleSize').onchange = () => document.getElementById('loadBtn').click();

            // Auto-select first and load
            if (sel.options.length > 0) {
                sel.selectedIndex = 0;
                document.getElementById('loadBtn').click();
            }
        }

        document.getElementById('loadBtn').onclick = async () => {
            currentRun = JSON.parse(document.getElementById('runSelect').value);
            annotations = {};

            // Show prompt
            if (currentRun.prompt_used) {
                document.getElementById('promptText').textContent = currentRun.prompt_used;
                document.getElementById('promptSection').style.display = 'block';
            }

            // Parse input columns
            let inputCols = [];
            try {
                inputCols = JSON.parse(currentRun.input_columns || '[]');
            } catch(e) {
                inputCols = (currentRun.input_columns || '').split(',').map(s => s.trim());
            }

            // Get output table
            let outputTable = currentRun.output_tables?.split(',')[0]?.trim();
            if (!outputTable || outputTable.includes('filtered')) {
                document.getElementById('samples').innerHTML = '<div class="status">No output table for this run</div>';
                return;
            }

            const size = document.getElementById('sampleSize').value;

            // Fetch samples from output table
            const result = db.exec(`SELECT * FROM "${outputTable}" ORDER BY RANDOM() LIMIT ${size}`);
            if (!result[0]) {
                document.getElementById('samples').innerHTML = '<div class="status">No data</div>';
                return;
            }

            const cols = result[0].columns;
            const outputColNames = (currentRun.output_columns || '').split(',').map(c => c.trim());

            samples = result[0].values.map((row, i) => {
                const s = { _idx: i, _cols: cols, _outputCols: outputColNames };
                cols.forEach((c, j) => s[c] = row[j]);
                return s;
            });

            // For each sample, fetch related input data
            await enrichSamplesWithInput(samples, inputCols, currentRun.run_id);

            render();
            document.getElementById('exportBtn').disabled = false;
        };

        async function enrichSamplesWithInput(samples, inputCols, runId) {
            for (const sample of samples) {
                sample._inputData = {};

                // For C4: fetch emails from thread_ids
                if (runId === 'C4') {
                    let threadIds = [];
                    try {
                        threadIds = JSON.parse(sample['thread_ids [C4]'] || '[]');
                    } catch(e) {}

                    if (threadIds.length > 0) {
                        // Get first 3 threads for context
                        const limitedIds = threadIds.slice(0, 3);
                        const placeholders = limitedIds.map(() => '?').join(',');
                        const msgs = db.exec(`SELECT thread_id, sender, receiver, cc, body FROM "1_discussion_messages" WHERE thread_id IN (${placeholders}) LIMIT 10`, limitedIds);

                        if (msgs[0]) {
                            sample._inputData.emails = msgs[0].values.map(row => ({
                                thread_id: row[0],
                                sender: row[1],
                                receiver: row[2],
                                cc: row[3],
                                body: row[4]
                            }));
                        }
                    }
                }

                // For C2: the input is already in the output table (name_mentioned [C1])
                // For C5: fetch cluster members and their relationships
                if (runId === 'C5') {
                    const clusterId = sample['cluster_id'];
                    if (clusterId !== undefined) {
                        const members = db.exec(`SELECT "name_id [C2]" FROM "7_network_cluster_members" WHERE cluster_id = ?`, [clusterId]);
                        if (members[0]) {
                            sample._inputData.members = members[0].values.map(r => r[0]);

                            // Get relationships for top members
                            const topMembers = sample._inputData.members.slice(0, 5);
                            if (topMembers.length > 0) {
                                const placeholders = topMembers.map(() => '?').join(',');
                                const rels = db.exec(`SELECT "name_id [C2]", "relationship_description [C4]" FROM "4_person_relationships" WHERE "name_id [C2]" IN (${placeholders})`, topMembers);
                                if (rels[0]) {
                                    sample._inputData.relationships = rels[0].values.map(r => ({ name: r[0], rel: r[1] }));
                                }
                            }
                        }
                    }
                }
            }
        }

        function render() {
            const container = document.getElementById('samples');
            container.innerHTML = '';

            samples.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'sample';
                div.id = `s${i}`;

                const cols = s._cols;
                const outputColNames = s._outputCols;

                // Separate input vs output columns
                const inputFields = cols.filter(c => !outputColNames.some(oc => c.includes(oc.replace(/\[.*\]/, '').trim())));
                const outputFields = cols.filter(c => outputColNames.some(oc => c.includes(oc.replace(/\[.*\]/, '').trim())));

                let html = `<div class="sample-header">#${i + 1}</div><div class="sample-content">`;

                // INPUT SECTION
                html += `<div class="section-title input">INPUT DATA</div>`;

                // Show enriched input data first
                if (s._inputData.emails) {
                    html += `<div class="field"><div class="field-label">Source Emails (${s._inputData.emails.length} shown)</div>`;
                    s._inputData.emails.forEach(email => {
                        html += `<div class="email-block">
                            <div class="email-meta"><b>From:</b> ${esc(email.sender || '')} <b>To:</b> ${esc(email.receiver || '')} ${email.cc ? `<b>CC:</b> ${esc(email.cc)}` : ''}</div>
                            <div class="email-body">${esc(email.body || '')}</div>
                        </div>`;
                    });
                    html += `</div>`;
                }

                if (s._inputData.members) {
                    html += `<div class="field"><div class="field-label">Cluster Members (${s._inputData.members.length})</div>
                        <div class="field-value">${s._inputData.members.map(m => esc(m)).join(',  ')}</div></div>`;
                }

                if (s._inputData.relationships) {
                    html += `<div class="field"><div class="field-label">Member Relationships</div>`;
                    s._inputData.relationships.forEach(r => {
                        html += `<div class="email-block">
                            <div class="email-meta"><b>${esc(r.name)}</b></div>
                            <div class="email-body">${esc(r.rel || '')}</div>
                        </div>`;
                    });
                    html += `</div>`;
                }

                // Show input columns from the table itself
                inputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '' && !c.startsWith('_')) {
                        let val = String(s[c]);
                        // Skip thread_ids in input since we show emails
                        if (c.includes('thread_ids') && s._inputData.emails) return;
                        // Format JSON arrays with spacing
                        if (val.startsWith('[') && val.endsWith(']')) {
                            try {
                                const arr = JSON.parse(val);
                                val = arr.join(',  ');
                            } catch(e) {}
                        }
                        html += `<div class="field"><div class="field-label">${c}</div><div class="field-value">${esc(val)}</div></div>`;
                    }
                });

                // OUTPUT SECTION
                html += `<div class="section-title output">AI OUTPUT (to evaluate)</div>`;

                outputFields.forEach(c => {
                    if (s[c] != null && s[c] !== '') {
                        let val = String(s[c]);
                        // Format JSON arrays with spacing
                        if (val.startsWith('[') && val.endsWith(']')) {
                            try {
                                const arr = JSON.parse(val);
                                val = arr.join(',  ');
                            } catch(e) {}
                        }
                        html += `<div class="field output"><div class="field-label">${c}</div><div class="field-value">${esc(val)}</div></div>`;
                    }
                });

                html += `</div>
                    <div class="sample-footer">
                        <div class="buttons">
                            <button class="btn btn-correct" onclick="annotate(${i},'correct')">Correct</button>
                            <button class="btn btn-incorrect" onclick="annotate(${i},'incorrect')">Incorrect</button>
                            <button class="btn btn-skip" onclick="annotate(${i},'skip')">Skip</button>
                        </div>
                    </div>`;

                div.innerHTML = html;
                container.appendChild(div);
            });

            updateStats();
        }

        function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function annotate(i, v) {
            annotations[i] = v;
            document.querySelectorAll(`#s${i} .btn`).forEach(b => b.classList.remove('selected'));
            document.querySelector(`#s${i} .btn-${v}`).classList.add('selected');
            updateStats();
        }

        function updateStats() {
            const n = samples.length;
            const done = Object.keys(annotations).length;
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;
            const total = correct + incorrect;

            const acc = total > 0 ? Math.round(correct / total * 100) : '--';
            document.getElementById('accuracy').textContent = `${acc}% (${correct}/${total})`;
            document.getElementById('progressBar').style.width = `${done / n * 100}%`;
        }

        document.getElementById('exportBtn').onclick = () => {
            const correct = Object.values(annotations).filter(v => v === 'correct').length;
            const incorrect = Object.values(annotations).filter(v => v === 'incorrect').length;

            const data = {
                run_id: currentRun.run_id,
                run_name: currentRun.run_name,
                date: new Date().toISOString(),
                accuracy: correct / (correct + incorrect) || null,
                correct, incorrect,
                skipped: Object.values(annotations).filter(v => v === 'skip').length,
                samples: samples.map((s, i) => {
                    const clean = { ...s };
                    delete clean._idx;
                    delete clean._cols;
                    delete clean._outputCols;
                    delete clean._inputData;
                    return { ...clean, annotation: annotations[i] || null };
                })
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentRun.run_id}_annotation_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };
    </script>
</body>
</html>
